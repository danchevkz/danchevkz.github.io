<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alexander Danchev | Blog</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="blog.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

  <header class="blog-header">
    <div class="blog-header-inner">
      <h1>Blog</h1>
      <a href="index.html" class="back-link">Back to Homepage</a>
    </div>
  </header>

  <div class="blog-controls" id="listControls">
    <div class="controls-inner">
      <div class="search-container">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
        </svg>
        <input type="text" class="search-input" id="searchInput" placeholder="Search posts...">
      </div>
      <div class="sort-container">
        <span class="sort-label">Sort by:</span>
        <select class="sort-select" id="sortSelect">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="title">Title (A-Z)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="tag-filter-bar" id="tagFilterBar">
    <div class="tag-filter-inner" id="tagFilters">
      <span class="tag-filter-label">Filter by tag:</span>
    </div>
  </div>

  <main class="blog-content">
    <div id="postsContainer">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Loading posts...</p>
      </div>
    </div>
  </main>

  <footer class="blog-footer">
    <p>Copyright ¬© Alexander Danchev 2025</p>
  </footer>

  <script>
    const POSTS_FOLDER = 'posts';
    const MANIFEST_FILE = 'posts/posts.json';

    let allPosts = [];
    let allTags = [];
    let activeTag = null;
    let currentSort = 'newest';

    marked.setOptions({ breaks: true, gfm: true });

    // URL handling
    function getPostFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('post');
    }

    function getTagFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('tag');
    }

    function navigateToPost(filename) {
      window.history.pushState({}, '', `?post=${encodeURIComponent(filename)}`);
      renderCurrentView();
    }

    function navigateToList(tag) {
      const url = tag ? `?tag=${encodeURIComponent(tag)}` : window.location.pathname;
      window.history.pushState({}, '', url);
      activeTag = tag;
      renderCurrentView();
    }

    // Initialize blog
    async function initBlog() {
      try {
        const response = await fetch(MANIFEST_FILE);
        if (!response.ok) throw new Error('Could not load posts manifest');

        const manifest = await response.json();

        const postPromises = manifest.posts.map(async (postMeta) => {
          try {
            const contentResponse = await fetch(`${POSTS_FOLDER}/${postMeta.file}`);
            if (!contentResponse.ok) return null;
            const content = await contentResponse.text();

            return {
              ...postMeta,
              content: content,
              htmlContent: marked.parse(content),
              dateObj: new Date(postMeta.date)
            };
          } catch (e) {
            console.warn(`Error loading post ${postMeta.file}:`, e);
            return null;
          }
        });

        allPosts = (await Promise.all(postPromises)).filter(p => p !== null);

        if (allPosts.length === 0) {
          showNoPosts();
          return;
        }

        // Collect unique tags
        const tagSet = new Set();
        allPosts.forEach(post => {
          if (post.tags) post.tags.forEach(tag => tagSet.add(tag));
        });
        allTags = Array.from(tagSet).sort();

        // Check URL for initial state
        activeTag = getTagFromURL();

        renderTagFilters();
        renderCurrentView();

      } catch (error) {
        console.error('Error initializing blog:', error);
        showNoPosts();
      }
    }

    function showNoPosts() {
      document.getElementById('postsContainer').innerHTML = `
        <div class="no-posts">
          <div class="no-posts-icon">üìù</div>
          <p>No blog posts yet.</p>
          <p style="font-size: 0.9rem; margin-top: 10px;">Add markdown files to the <code>posts</code> folder and update <code>posts.json</code>.</p>
        </div>
      `;
      document.getElementById('listControls').classList.add('hide');
      document.getElementById('tagFilterBar').classList.add('hide');
    }

    function renderTagFilters() {
      const container = document.getElementById('tagFilters');
      let html = '<span class="tag-filter-label">Filter by tag:</span>';
      html += `<button class="tag-btn clear-btn ${!activeTag ? 'active' : ''}" onclick="navigateToList(null)">All</button>`;
      allTags.forEach(tag => {
        html += `<button class="tag-btn ${activeTag === tag ? 'active' : ''}" onclick="navigateToList('${tag}')">${tag}</button>`;
      });
      container.innerHTML = html;
    }

    function renderCurrentView() {
      const postFile = getPostFromURL();
      if (postFile) {
        renderSinglePost(postFile);
      } else {
        renderPostList();
      }
    }

    function renderPostList() {
      document.getElementById('listControls').classList.remove('hide');
      document.getElementById('tagFilterBar').classList.remove('hide');
      document.title = 'Alexander Danchev | Blog';

      renderTagFilters();

      let posts = [...allPosts];

      // Filter by tag
      if (activeTag) {
        posts = posts.filter(p => p.tags && p.tags.includes(activeTag));
      }

      // Sort
      switch (currentSort) {
        case 'newest': posts.sort((a, b) => b.dateObj - a.dateObj); break;
        case 'oldest': posts.sort((a, b) => a.dateObj - b.dateObj); break;
        case 'title': posts.sort((a, b) => a.title.localeCompare(b.title)); break;
      }

      // Search
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      if (query) {
        posts = posts.filter(post =>
          post.title.toLowerCase().includes(query) ||
          post.excerpt.toLowerCase().includes(query) ||
          post.content.toLowerCase().includes(query) ||
          (post.tags && post.tags.some(tag => tag.toLowerCase().includes(query)))
        );
      }

      const container = document.getElementById('postsContainer');

      if (posts.length === 0) {
        container.innerHTML = `
          <div class="no-posts">
            <div class="no-posts-icon">üîç</div>
            <p>No posts match your criteria.</p>
          </div>
        `;
        return;
      }

      const countText = posts.length === 1 ? '1 post' : `${posts.length} posts`;
      let html = `<p class="posts-count">${countText}${activeTag ? ` tagged "${activeTag}"` : ''}</p>`;

      posts.forEach(post => {
        const formattedDate = formatDate(post.dateObj);
        const tagsHtml = post.tags ? post.tags.map(tag =>
          `<button class="post-tag" onclick="event.stopPropagation(); navigateToList('${tag}')">${tag}</button>`
        ).join('') : '';

        html += `
          <div class="post-card" onclick="navigateToPost('${post.file}')">
            <div class="post-card-inner">
              <div class="post-meta">
                <span class="post-date">${formattedDate}</span>
                ${tagsHtml ? `<div class="post-tags">${tagsHtml}</div>` : ''}
              </div>
              <h2 class="post-title">${escapeHtml(post.title)}</h2>
              <p class="post-excerpt">${escapeHtml(post.excerpt)}</p>
              <div class="post-read-more">Read more</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderSinglePost(filename) {
      document.getElementById('listControls').classList.add('hide');
      document.getElementById('tagFilterBar').classList.add('hide');

      const post = allPosts.find(p => p.file === filename);

      if (!post) {
        document.getElementById('postsContainer').innerHTML = `
          <div class="no-posts">
            <div class="no-posts-icon">‚ùì</div>
            <p>Post not found.</p>
            <p><a href="blog.html" style="color: #6a8ab0;">‚Üê Back to all posts</a></p>
          </div>
        `;
        return;
      }

      document.title = `${post.title} | Alexander Danchev`;

      const formattedDate = formatDate(post.dateObj);
      const tagsHtml = post.tags ? post.tags.map(tag =>
        `<button class="post-tag" onclick="navigateToList('${tag}')">${tag}</button>`
      ).join('') : '';

      // Prev/next navigation
      const sortedPosts = [...allPosts].sort((a, b) => b.dateObj - a.dateObj);
      const currentIndex = sortedPosts.findIndex(p => p.file === filename);
      const prevPost = sortedPosts[currentIndex + 1];
      const nextPost = sortedPosts[currentIndex - 1];

      let navHtml = '<div class="post-nav">';
      if (prevPost) {
        navHtml += `<span class="post-nav-link prev" onclick="navigateToPost('${prevPost.file}')">${escapeHtml(prevPost.title)}</span>`;
      }
      if (nextPost) {
        navHtml += `<span class="post-nav-link next" onclick="navigateToPost('${nextPost.file}')">${escapeHtml(nextPost.title)}</span>`;
      }
      navHtml += '</div>';

      document.getElementById('postsContainer').innerHTML = `
        <article class="single-post">
          <header class="single-post-header">
            <span class="single-post-back" onclick="navigateToList(null)">All posts</span>
            <h1 class="single-post-title">${escapeHtml(post.title)}</h1>
            <div class="single-post-meta">
              <span class="post-date">${formattedDate}</span>
              ${tagsHtml ? `<div class="post-tags">${tagsHtml}</div>` : ''}
            </div>
          </header>
          <div class="single-post-content">
            ${post.htmlContent}
          </div>
          ${navHtml}
        </article>
      `;

      window.scrollTo(0, 0);
    }

    function formatDate(date) {
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', renderPostList);
    document.getElementById('sortSelect').addEventListener('change', (e) => {
      currentSort = e.target.value;
      renderPostList();
    });
    window.addEventListener('popstate', renderCurrentView);

    document.addEventListener('DOMContentLoaded', initBlog);
  </script>

</body>
</html>
